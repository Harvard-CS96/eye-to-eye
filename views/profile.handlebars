<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="static/css/profile.css">

{{> nav}}

<div id="profile-container">
    <h1 id="user-hello"></h1>
    <div class="container">
        <div class="col-md-12 text-center">
            <button class="btn btn-primary" id="convo-button">Talk with Someone</button>
        </div>
    </div>
    <div class="tab">
        <button class="tablinks col-md-4 bottombar" onclick="openCity(event, 'My Questions')" id="defaultOpen">My Questions</button>
        <button class="tablinks col-md-4 bottombar" onclick="openCity(event, 'My Stats')">My Stats</button>
        <button class="tablinks col-md-4 bottombar" onclick="openCity(event, 'My History')">My History</button>
    </div>

    <div id="My Questions" class="tabcontent">
        {{> questions }}
    </div>

    <div id="My Stats" class="tabcontent">
    <div class="holder">
        <hr>
        <div id="star-area">
            Average star rating:
            <span id="star1">&#9733;</span></span>
            <span id="star2">&#9733;</span></span>
            <span id="star3">&#9733;</span></span>
            <span id="star4">&#9733;</span></span>
            <span id="star5">&#9733;</span></span>
        </div>
        <div>
            Your conversation count: <span id="convo-count"></span>
        </div>
        <div id="badge-area" style="align: center;">
            See your badges:
            <table>
                <tr>
                    <td>
                        <span id="creative" onclick="changeSelected('creative')" class="fa fa-wrench"></span>
                        <p>Creative<span id="creative-count"></span></p>
                    </td>
                    <td>
                        <span id="polite" onclick="changeSelected('polite')" class="fa fa-handshake-o"></span>
                        <p>Polite<span id="polite-count"></span></p>
                    </td>
                </tr>
                <tr>
                    <td>
                        <span id="knowledgeable" onclick="changeSelected('knowledgeable')" class="fa fa-book"></span>
                        <p>Knowledgeable<span id="knowledgeable-count"></span></p>
                    </td>
                    <td>
                        <span id="empathetic" onclick="changeSelected('empathetic')" class="fa fa-heart"></span>
                        <p>Empathetic<span id="empathetic-count"></span></p>
                    </td>
                </tr>
            </table>
        </div>
        <br/>
        <div>
            Click to view your friends leaderboards! (by clicking, you allow your friends to see your badges as well).
            <div id="leaderboard"></div>
        </div>
    </div>

    <div id="My History" class="tabcontent">
        <div class="holder">
            <div id="history-area" style="align: center;">
                Your past conversations:
                <table id="history-table">
                    <tr>
                        <td>
                            <p><strong>Name</strong></p>
                        </td>
                        <td>
                            <p><strong>Message</strong></p>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>



</div>

<script type='text/javascript'>
    var user = {{{ user }}};

    function paintStars(nStars) {
        // console.log(nStars);
        for (i = 1; i <= nStars; i++) {
            var elt = $('#star' + i.toString());
            elt.html('&#9733;');
        };
        for (i = nStars + 1; i <= 5; i++) {
            var elt = $('#star' + i.toString());
            elt.html('&#x2606');
        };
    }

    function countBadges(badgeName, person) {
        console.log('badgename');
        var count = 0;
        person.badges.forEach(function(d) {
            if (d.badge == badgeName) {
                count = d.count;
            }
        })
        return count;
    }

    function buildLeaderboard(leaders) {
        var start = '<table><tr><th>Friend</th><th>Empathetic</th><th>Polite</th><th>Knowledgeable</th><th>Creative</th><tr>';
        var s = '';
        leaders.forEach(friend => {
            s += '<tr><td>' + friend.name + '</td><td>' + countBadges('empathetic', friend) + '</td><td>' +
                countBadges('polite', friend) + '</td><td>' + countBadges('knowledgeable', friend) + '</td><td>' +
                countBadges('creative', friend) + '</td></tr>';
        });
        var end = '</table>';
        var final = start + s + end;
        console.log(final);
        return final;
    }

    function getLeaderboard() {
        $.ajax({
            type: 'GET',
            contentType: 'application/json; charset=utf-8',
            url: '/profile/leaderboard',
            success: res => {
                console.log(res);
                $('#leaderboard')[0].innerHTML = buildLeaderboard(res);
            }
        })
    }

    function getHistory() {
        $.ajax({
            type: 'GET',
            contentType: 'application/json; charset=utf-8',
            url: '/profile/chats',
            success: res => {

                // Double-check conversation count
                if (res.length > $("#convo-count").text) {
                    $("#convo-count").text(res.length);
                }

                // Populate history form
                var table_html = ""
                res.forEach(row => {
                    
                    // Chat data and chat partner's name
                    var [chat, name] = row
                    var feedback = chat.feedback.filter(f => {f.from !== user.uuid})[0];
                    
                    // TODO: Build up html here
                })

                // TODO: append results to table
            }
        })
    }

    $(document).ready(function() {
        jQuery(function() {
            $("#user-hello").html("Welcome to your profile, " + user.facebook.name + "!");
            paintStars(+user.rating.stars);
            $('#convo-count').html(user.rating.count);
            ['empathetic', 'knowledgeable', 'creative', 'polite'].forEach(function(d) {
                $('#' + d + '-count').html(': ' + countBadges(d, user));
            })

            // show leaderboard right away if user has already selected to see their leaderboard
            if (user.show_leaderboard) {
                getLeaderboard();
            } else {
                // add button for showing leaderboard for the first time
                $("#leaderboard").append(
                    '<button class="btn btn-outline-primary" id="show-leaderboard">Authorize Facebook Friends to See Leaderboard</button>'
                )
                $("#show-leaderboard").on("click", e => {
                    getLeaderboard()
                    $("#show-leaderboard").remove()
                })
            }

            $("#convo-button").on("click", (e) => {
                window.location.href= '/';
            })
        });
    });

    function openCity(evt, cityName) {
        // Declare all variables
        var i, tabcontent, tablinks;

        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(cityName).style.display = "block";
        evt.currentTarget.className += " active";
    }

// Get the element with id="defaultOpen" and click on it
document.getElementById("defaultOpen").click();
</script>
